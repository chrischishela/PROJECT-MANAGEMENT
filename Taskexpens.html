<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Expense Sheet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 {
            text-align: center;
            color: #007bff;
        }

        .filter,
        .archive-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .filter input,
        .archive-section button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .archive-section {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .archive-button,
        .view-archive-button {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .view-archive-button {
            background-color: #17a2b8;
        }

        .archive-button:hover,
        .view-archive-button:hover {
            background-color: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #007bff;
            color: #fff;
        }

        .total {
            margin-top: 20px;
            text-align: right;
            font-size: 18px;
        }

        .add-expense-form {
            margin-bottom: 20px;
        }

        .add-expense-form input,
        .add-expense-form select,
        .add-expense-form button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .add-expense-form button {
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .add-expense-form button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div class="container" id="mainContainer">
        <h1>Task Expense Sheet</h1>
        <div class="archive-section">
            <input type="text" id="archiveIdInput" placeholder="Enter Task ID to Archive">
            <button class="archive-button" onclick="archiveTasks()">Archive All</button>
            <button class="view-archive-button" onclick="viewArchivedTasks()">View Archived Tasks</button>
        </div>
        <div class="filter">
            <label for="taskFilter">Filter by Task ID:</label>
            <input type="text" id="taskFilter" placeholder="Enter Task ID">
        </div>
        <div class="add-expense-form">
            <h2>Add New Expense</h2>
            <form id="addExpenseForm">
                <input type="date" id="date" required placeholder="Date">
                <input type="text" id="taskId" required placeholder="Task ID">
                <input type="text" id="projectName" required placeholder="Project Name">
                <input type="text" id="taskDescription" required placeholder="Task Description">
                <select id="supplier" required>
                    <option value="">Select Supplier</option>
                    <option value="Hazida Motors">Hazida Motors</option>
                    <option value="Freight and Passengers">Freight and Passengers</option>
                    <option value="Hazida Limited">Hazida Limited</option>
                </select>
                <input type="text" id="vat" required placeholder="VAT">
                <select id="payee" required>
                    <option value="">Select Payee</option>
                    <option value="Hazida Limited">Hazida Limited</option>
                    <option value="Hazida Motors">Hazida Motors</option>
                    <option value="Freight and Passengers Limited">Freight and Passengers Limited</option>
                </select>
                <input type="number" id="qty" required placeholder="Quantity">
                <select id="resourceName" required>
                    <option value="">Select Resource Name</option>
                </select>
                <input type="number" id="amount" required placeholder="Amount" readonly>

                <label for="labor">Labor:</label>
                <select id="labor" required>
                    <option value="">Select Labor</option>
                    <option value="BRIGHTON MATOLOKOSH">BRIGHTON MATOLOKOSH</option>
                    <option value="CAPHAS TEMBO">CAPHAS TEMBO</option>
                    <option value="CLISHA MAMBILIMA">CLISHA MAMBILIMA</option>
                    <option value="DABSON DAKA">DABSON DAKA</option>
                    <option value="DANNY MVULA">DANNY MVULA</option>
                    <option value="JAMES DAKA">JAMES DAKA</option>
                    <option value="JOSEPH TEMBO">JOSEPH TEMBO</option>
                    <option value="LUCKSON PHIRI">LUCKSON PHIRI</option>
                    <option value="MICHEAL LOBELA">MICHEAL LOBELA</option>
                    <option value="OBERT SIAME">OBERT SIAME</option>
                    <option value="DOMINIC SAKALA">DOMINIC SAKALA</option>
                    <option value="PETER MAWERE">PETER MAWERE</option>
                    <option value="SAVIOUR PHIRI">SAVIOUR PHIRI</option>
                    <option value="TEMBEYA SAKALA">TEMBEYA SAKALA</option>
                    <option value="KELVIN SIAME">KELVIN SIAME</option>
                </select>
                <input type="number" id="hours" required placeholder="Hours">
                <input type="number" id="laborCost" required placeholder="Labor Cost" readonly>
                <button type="submit">Add Expense</button>
            </form>
        </div>
        <table>
            <thead>
                <tr>
                    <th>DATE</th>
                    <th>TASK ID</th>
                    <th>PROJECT NAME</th>
                    <th>RESOURCE NAME</th>
                    <th>TASK DESCRIPTION</th>
                    <th>SUPPLIER</th>
                    <th>VAT</th>
                    <th>PAYEE</th>
                    <th>QTY</th>
                    <th>AMOUNT</th>
                    <th>LABOR COST</th>
                    <th>TOTAL</th>
                    <th>ACTION</th>
                </tr>
            </thead>
            <tbody id="expenseTable">
                <!-- Expense rows will be added here dynamically -->
            </tbody>
        </table>
        <div class="total">
            Total Cost of Task: <span id="totalCost">0</span>
        </div>
    </div>

    <div class="container" id="archivedContainer" style="display:none;">
        <h1>Archived Tasks</h1>
        <table>
            <thead>
                <tr>
                    <th>DATE</th>
                    <th>TASK ID</th>
                    <th>PROJECT NAME</th>
                    <th>RESOURCE NAME</th>
                    <th>TASK DESCRIPTION</th>
                    <th>SUPPLIER</th>
                    <th>VAT</th>
                    <th>PAYEE</th>
                    <th>QTY</th>
                    <th>AMOUNT</th>
                    <th>LABOR COST</th>
                    <th>TOTAL</th>
                </tr>
            </thead>
            <tbody id="archivedTasksTable">
                <!-- Archived tasks will be added here dynamically -->
            </tbody>
        </table>
        <button class="view-archive-button" onclick="viewMainTasks()">Back to Main Tasks</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFGX-J09YjbCe_u58yexo7EgVqWwPje0",
            authDomain: "project-management-a1c5e.firebaseapp.com",
            databaseURL: "https://project-management-a1c5e-default-rtdb.firebaseio.com/",
            projectId: "project-management-a1c5e",
            storageBucket: "project-management-a1c5e.appspot.com",
            messagingSenderId: "662718236281",
            appId: "1:662718236281:web:e859b39671aefa67e436a8",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Fetch inventory data from Firebase and populate the resourceName dropdown
        function loadResourceNames() {
            const inventoryRef = ref(db, "inventory/");
            onValue(inventoryRef, (snapshot) => {
                const resourceNameSelect = document.getElementById('resourceName');
                resourceNameSelect.innerHTML = '<option value="">Select Resource Name</option>'; // Clear existing options
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach((key) => {
                        const item = data[key];
                        const option = document.createElement('option');
                        option.value = item.price;
                        option.text = item.name;
                        resourceNameSelect.appendChild(option);
                    });
                }
            });
        }

        // Update amount input when a resource name is selected
        document.getElementById('resourceName').addEventListener('change', function() {
            document.getElementById('amount').value = this.value;
        });

        // Calculate labor cost
        document.getElementById('hours').addEventListener('input', function() {
            const hours = parseFloat(this.value) || 0;
            const laborCost = hours * 20; // K20 per hour
            document.getElementById('laborCost').value = laborCost.toFixed(2);
        });

        document.getElementById('taskFilter').addEventListener('input', function() {
            const filterValue = this.value;
            const table = document.getElementById('expenseTable');
            const rows = table.getElementsByTagName('tr');
            let totalCost = 0;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                const taskId = cells[1].innerText;
                const rowTotal = parseFloat(cells[11].innerText);

                if (taskId.includes(filterValue)) {
                    rows[i].style.display = '';
                    totalCost += rowTotal;
                } else {
                    rows[i].style.display = 'none';
                }
            }

            document.getElementById('totalCost').innerText = totalCost.toFixed(2);
        });

        document.getElementById('addExpenseForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const date = document.getElementById('date').value;
            const taskId = document.getElementById('taskId').value;
            const projectName = document.getElementById('projectName').value;
            const taskDescription = document.getElementById('taskDescription').value;
            const supplier = document.getElementById('supplier').value;
            const vat = document.getElementById('vat').value;
            const payee = document.getElementById('payee').value;
            const qty = parseInt(document.getElementById('qty').value);
            const resourceName = document.getElementById('resourceName').options[document.getElementById('resourceName').selectedIndex].text;
            const amount = parseFloat(document.getElementById('amount').value);
            const total = qty * amount;

            const labor = document.getElementById('labor').value;
            const hours = parseFloat(document.getElementById('hours').value);
            const laborCost = parseFloat(document.getElementById('laborCost').value);

            // Fetch inventory data from Firebase
            const inventoryRef = ref(db, "inventory/");
            onValue(inventoryRef, (snapshot) => {
                const data = snapshot.val();
                const item = Object.values(data).find(i => i.name === resourceName);

                if (item && qty <= item.stockAvailable) {
                    // Update the inventory
                    const itemRef = ref(db, `inventory/${Object.keys(data).find(key => data[key].name === resourceName)}`);
                    update(itemRef, {
                        stockAvailable: item.stockAvailable - qty,
                        requested: (item.requested || 0) + qty
                    });

                    // Log the history
                    const historyRef = ref(db, "history/");
                    const newHistoryRef = push(historyRef);
                    set(newHistoryRef, {
                        action: "Allocate",
                        details: `Allocated ${qty} of item ${resourceName} from bin ${item.binId} to task ${taskId} for project ${projectName}`,
                        timestamp: new Date().toISOString()
                    });

                    // Add expense to the table
                    const table = document.getElementById('expenseTable');
                    const newRow = table.insertRow();

                    newRow.insertCell(0).innerText = date;
                    newRow.insertCell(1).innerText = taskId;
                    newRow.insertCell(2).innerText = projectName;
                    newRow.insertCell(3).innerText = resourceName;
                    newRow.insertCell(4).innerText = taskDescription;
                    newRow.insertCell(5).innerText = supplier;
                    newRow.insertCell(6).innerText = vat;
                    newRow.insertCell(7).innerText = payee;
                    newRow.insertCell(8).innerText = qty;
                    newRow.insertCell(9).innerText = amount.toFixed(2);
                    newRow.insertCell(10).innerText = laborCost.toFixed(2);
                    newRow.insertCell(11).innerText = (total + laborCost).toFixed(2);

                    const archiveButton = document.createElement('button');
                    archiveButton.className = 'archive-button';
                    archiveButton.innerText = 'Archive';
                    archiveButton.onclick = function() {
                        archiveTasksById(taskId);
                    };
                    const actionCell = newRow.insertCell(12);
                    actionCell.appendChild(archiveButton);

                    // Clear the form
                    document.getElementById('addExpenseForm').reset();
                    document.getElementById('amount').value = '';
                    document.getElementById('laborCost').value = '';

                    // Update total cost
                    updateTotalCost();
                } else {
                    alert('Insufficient stock available or item not found in inventory.');
                }
            }, { onlyOnce: true });
        });

        function updateTotalCost() {
            const table = document.getElementById('expenseTable');
            const rows = table.getElementsByTagName('tr');
            let totalCost = 0;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                const rowTotal = parseFloat(cells[11].innerText);
                totalCost += rowTotal;
            }

            document.getElementById('totalCost').innerText = totalCost.toFixed(2);
        }

        function archiveTasks() {
            const archiveId = document.getElementById('archiveIdInput').value;
            archiveTasksById(archiveId);
        }

        function archiveTasksById(taskId) {
            const table = document.getElementById('expenseTable');
            const rows = table.getElementsByTagName('tr');
            const archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];

            for (let i = rows.length - 1; i >= 0; i--) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells[1].innerText === taskId) {
                    const archivedTask = {
                        date: cells[0].innerText,
                        taskId: cells[1].innerText,
                        projectName: cells[2].innerText,
                        resourceName: cells[3].innerText,
                        taskDescription: cells[4].innerText,
                        supplier: cells[5].innerText,
                        vat: cells[6].innerText,
                        payee: cells[7].innerText,
                        qty: cells[8].innerText,
                        amount: cells[9].innerText,
                        laborCost: cells[10].innerText,
                        total: cells[11].innerText
                    };
                    archivedTasks.push(archivedTask);
                    table.deleteRow(i);
                }
            }
            localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            updateTotalCost();
        }

        function viewArchivedTasks() {
            document.getElementById('mainContainer').style.display = 'none';
            const archivedContainer = document.getElementById('archivedContainer');
            const archivedTasksTable = document.getElementById('archivedTasksTable');
            archivedTasksTable.innerHTML = '';

            const archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
            archivedTasks.forEach(task => {
    const newRow = archivedTasksTable.insertRow();

    newRow.insertCell(0).innerText = task.date;
    newRow.insertCell(1).innerText = task.taskId;
    newRow.insertCell(2).innerText = task.projectName;
    newRow.insertCell(3).innerText = task.resourceName;
    newRow.insertCell(4).innerText = task.taskDescription;
    newRow.insertCell(5).innerText = task.supplier;
    newRow.insertCell(6).innerText = task.vat;
    newRow.insertCell(7).innerText = task.payee;
    newRow.insertCell(8).innerText = task.qty;
    newRow.insertCell(9).innerText = task.amount;
    newRow.insertCell(10).innerText = task.laborCost;
    newRow.insertCell(11).innerText = task.total;
});

archivedContainer.style.display = 'block';
}

function viewMainTasks() {
    document.getElementById('archivedContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
}

// Load resource names when the page loads
window.onload = function() {
    loadResourceNames();
};
</script>
</body>
</html>
